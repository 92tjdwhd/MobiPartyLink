# 마비노기 모바일 파티 모집 앱 (MVP) – 개발 설계 정책서

## 1. 개요
- **서비스명(가칭)**: 마비노기 모바일 파티 모집 앱  
- **목적**: 파티 모집 → 참여 → 관리 → 알림 전 과정을 앱 내에서 간소화  
- **백엔드**: Supabase (DB·인증·스토리지), Firebase Analytics(로그/분석)  
- **클라이언트**: Flutter 앱  

---

## 2. 사용자 관리
- **식별자**: Supabase Anonymous Auth `uid`  
- **로그인 시점**:  
  - 앱 실행 시 자동 로그인 ❌  
  - 사용자가 **파티 생성/참여 버튼 클릭 시점**에만 `signInAnonymously()` 실행  
- **프로필 관리**:  
  - 파티 가입 시 입력 (닉네임/직업/투력)  
  - "내 프로필로 저장" 체크 시 로컬 저장  
  - 로컬 변경 발생 시 서버 `user_profiles` 업데이트  

---

## 3. 파티 생성
- 방장은 생성 즉시 **자동 참가 처리**  
- 필수 입력: 파티명, 날짜/시간, 최대 인원, 콘텐츠 종류  
- 옵션: 직업/투력 입력 필수 여부  
- **역할별 최소 인원 설정 가능** (탱커·힐러 등)  
- **던전/레이드 템플릿 지원**:  
  - 선택 시 기본 인원/역할 자동 세팅  
  - 제목·인원수·역할은 커스텀 가능  
  - 템플릿은 앱 번들에 포함, 서버 버전 확인 후 필요 시 업데이트  
- 생성 제한: 동시에 최대 5개 (`pending/ongoing` 포함, `ended` 제외)  

---

## 4. 파티 참여
- 초대 링크: 카카오링크 카드 + Firebase Dynamic Link 조합  
- Dynamic Link 데이터: `partyId` + 기본정보(title, dateTime, maxMember, raidType)  
- 앱 실행 시 기본정보 프리뷰 표시 후 서버 fetch로 최신화  
- "참여하기" 버튼 시점에 트랜잭션 처리:  
  - 인원 초과, 역할 슬롯 가득 참 → 참여 차단  
- 참여 제한: 동시에 최대 5개 (`pending/ongoing` 포함)  
- 참여 성공 시: 파티 시작 10분 전 로컬 알림 예약  

---

## 5. 파티 상태
- **pending**: 시작 전  
- **ongoing**: 시작 시간 도달 시 자동 전환  
- **ended**: 시작 후 1시간 경과 시 자동 전환  
- 종료된 파티는 삭제하지 않고 **상태만 ended**로 유지  

---

## 6. 파티 관리
- 참가자 리스트:  
  - 닉네임: 항상 표시  
  - 직업/투력: 방장이 필수로 지정 시 표시  
- **강퇴**: 참가자 row 삭제 + currentCount -1 + Direct Push 발송  
- **탈퇴**: 본인 row 삭제 + currentCount -1 + 예약 알림 취소  
- 파티 취소 기능 없음 → Host는 종료만 확인  

---

## 7. 알림 정책
- **로컬 알림**: 파티 참여 시 예약(시작 10분 전)  
- **서버 푸시(FCM)**: 특수 이벤트(강퇴 등)만 Direct Push  

---

## 8. 파티 리스트 UI
- 내가 만든/참여한 파티 → 단일 리스트 카드뷰  
- 카드 구성: 파티명, 시작 시간, 인원 현황(current/max), 상태 라벨  
- 상태 라벨: 예정 / 진행중 / 종료  
- 정렬: 예정·진행중 상단, 종료 하단  

---

## 9. 던전/레이드 템플릿 관리
- **기본**: 앱 설치 시 로컬에 하드코딩된 템플릿 데이터 포함  
- **버전 관리**: 로컬에 `template_version` 저장  
- **업데이트**: 서버에서 최신 버전 확인 → 다르면 JSON 다운로드 후 교체  
- 커스텀 허용: 제목·인원수·역할 조정 가능  

---

## 10. 추가 고려 사항

### 시간 처리
- **한국(Asia/Seoul) 로컬 시간** 기준 관리  

### 에러/예외 메시지
- 참가:  
  - `"파티가 가득 찼습니다"`  
  - `"해당 역할 자리가 없습니다"`  
  - `"이미 종료된 파티입니다"`  
- 생성:  
  - `"최대 5개까지만 생성 가능합니다"`  

### 오프라인 처리
- MVP: 단순 차단 → `"인터넷 연결을 확인해주세요"`  

### 알림 중복 처리
- 참여/탈퇴 반복 → 기존 예약 취소 후 새 예약  
- 앱 삭제/재설치 시 알림 초기화  

### 데이터 동기화
- 앱 실행 시 내 파티 목록/프로필 싱크  
- 실시간 구독(Realtime)은 MVP에서는 제외  

### 보안/접근 제어
- Dynamic Link 접근 시 서버 검증 필수  
  - 종료된 파티 → 참여 불가  
  - 정원 초과 → 참여 불가  
  - 강퇴자는 재참여 허용(서버 로그 기록만 남김)  

### 로그/분석
- Firebase Analytics 활용 (무료)  
- 이벤트 기록: 파티 생성 / 참여 / 탈퇴 / 강퇴 / 알림 예약 / 알림 클릭  

---

## 11. 기술 스택 정책

### 백엔드
- **데이터베이스**: Supabase PostgreSQL
- **인증**: Supabase Auth (Anonymous)
- **스토리지**: Supabase Storage
- **실시간**: Supabase Realtime (MVP 제외)
- **분석**: Firebase Analytics

### 클라이언트
- **프레임워크**: Flutter 3.0+
- **상태관리**: Riverpod
- **아키텍처**: Clean Architecture
- **네트워킹**: Dio + Retrofit
- **로컬저장**: SharedPreferences + Hive
- **알림**: Local Notifications + FCM

### 외부 서비스
- **공유**: 카카오링크 + Firebase Dynamic Links
- **시간대**: Asia/Seoul (한국 표준시)

---

## 12. 개발 우선순위

### Phase 1 (MVP)
1. 사용자 인증 (Anonymous)
2. 파티 생성/참여 기본 기능
3. 파티 상태 관리
4. 로컬 알림
5. 기본 UI/UX

### Phase 2 (향후)
1. 실시간 업데이트
2. 고급 알림 기능
3. 템플릿 관리 시스템
4. 상세 분석 기능
5. 사용자 피드백 시스템

---

*최종 업데이트: 2024년 12월*
